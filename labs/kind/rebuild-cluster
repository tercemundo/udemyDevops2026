#!/bin/bash

# rebuild-cluster.sh - Script para recrear clÃºster Kind con soporte completo de Portainer
# Uso: ./rebuild-cluster.sh

set -e

CLUSTER_NAME="lab-kind"
WORK_DIR="/tmp/rebuild-cluster"
NAMESPACE_PORTAINER="portainer"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${BLUE}â•‘ $1${NC}"
    echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

print_step() {
    echo -e "\n${BOLD}${CYAN}â–¶ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}

print_info() {
    echo -e "${MAGENTA}â„¹ $1${NC}"
}

# FunciÃ³n para detectar la IP local
get_local_ip() {
    local ip=""
    
    # MÃ©todo 1: Usando ip route (mÃ¡s confiable)
    if command -v ip &> /dev/null; then
        ip=$(ip -4 route get 8.8.8.8 2>/dev/null | grep -oP 'src \K[0-9.]+' | head -n 1)
        if [[ "$ip" =~ ^192\.168\. ]]; then
            echo "$ip"
            return 0
        fi
    fi
    
    # MÃ©todo 2: Usando hostname -I (alternativa)
    if command -v hostname &> /dev/null; then
        ip=$(hostname -I 2>/dev/null | tr ' ' '\n' | grep '^192\.168\.' | head -n 1)
        if [ -n "$ip" ]; then
            echo "$ip"
            return 0
        fi
    fi
    
    # MÃ©todo 3: Usando ifconfig (fallback para sistemas antiguos)
    if command -v ifconfig &> /dev/null; then
        ip=$(ifconfig 2>/dev/null | grep 'inet ' | awk '{print $2}' | grep '^192\.168\.' | head -n 1)
        if [ -n "$ip" ]; then
            echo "$ip"
            return 0
        fi
    fi
    
    # MÃ©todo 4: Usando ip addr (alternativa con ip)
    if command -v ip &> /dev/null; then
        ip=$(ip -4 addr 2>/dev/null | grep -oP '(?<=inet\s)\d+\.\d+\.\d+\.\d+' | grep '^192\.168\.' | head -n 1)
        if [ -n "$ip" ]; then
            echo "$ip"
            return 0
        fi
    fi
    
    # Si no se encuentra ninguna IP 192.168.x.x, devolver localhost
    echo "localhost"
}

# Detectar IP local al inicio
HOST_IP=$(get_local_ip)

# ConfirmaciÃ³n antes de proceder
echo -e "${BOLD}${RED}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘          âš   ADVERTENCIA: OPERACIÃ“N DESTRUCTIVA  âš             â•‘
â•‘                                                               â•‘
â•‘  Este script realizarÃ¡ las siguientes acciones:               â•‘
â•‘                                                               â•‘
â•‘  1. Desinstalar Portainer completamente                       â•‘
â•‘  2. Eliminar el clÃºster Kind existente                        â•‘
â•‘  3. Crear nuevo clÃºster Kind con 3 nodos                      â•‘
â•‘  4. Configurar extraPortMappings para Portainer               â•‘
â•‘  5. Reinstalar Portainer con acceso NodePort                  â•‘
â•‘                                                               â•‘
â•‘  âš  TODOS LOS DATOS DEL CLÃšSTER SE PERDERÃN âš                 â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo -e "${YELLOW}ClÃºster a eliminar: ${BOLD}$CLUSTER_NAME${NC}"
echo -e "${CYAN}IP local detectada: ${BOLD}$HOST_IP${NC}"
echo ""
read -p "Â¿Deseas continuar? (escribe 'SI' para confirmar): " confirm

if [ "$confirm" != "SI" ]; then
    print_error "OperaciÃ³n cancelada por el usuario"
    exit 0
fi

mkdir -p "$WORK_DIR"

# ============================================================================
print_header "FASE 1: DESINSTALACIÃ“N DE PORTAINER"
# ============================================================================

print_step "Verificando si Portainer estÃ¡ instalado..."

if kubectl get namespace "$NAMESPACE_PORTAINER" &> /dev/null; then
    print_warning "Portainer encontrado. Procediendo con desinstalaciÃ³n..."
    
    print_step "Eliminando deployment..."
    kubectl delete deployment portainer -n "$NAMESPACE_PORTAINER" --ignore-not-found=true
    print_success "Deployment eliminado"
    
    print_step "Eliminando servicios..."
    kubectl delete service portainer -n "$NAMESPACE_PORTAINER" --ignore-not-found=true
    print_success "Servicios eliminados"
    
    print_step "Eliminando PersistentVolumeClaim..."
    kubectl delete pvc portainer-data -n "$NAMESPACE_PORTAINER" --ignore-not-found=true
    print_success "PVC eliminado"
    
    print_step "Eliminando ClusterRoleBinding..."
    kubectl delete clusterrolebinding portainer-crb-clusteradmin --ignore-not-found=true
    print_success "ClusterRoleBinding eliminado"
    
    print_step "Eliminando ServiceAccount..."
    kubectl delete serviceaccount portainer-sa-clusteradmin -n "$NAMESPACE_PORTAINER" --ignore-not-found=true
    print_success "ServiceAccount eliminado"
    
    print_step "Eliminando namespace..."
    kubectl delete namespace "$NAMESPACE_PORTAINER" --ignore-not-found=true
    
    # Esperar a que el namespace se elimine completamente
    print_info "Esperando a que el namespace se elimine completamente..."
    timeout 60 bash -c "while kubectl get namespace $NAMESPACE_PORTAINER &> /dev/null; do sleep 2; done" || true
    print_success "Namespace eliminado completamente"
else
    print_info "Portainer no estÃ¡ instalado, continuando..."
fi

# ============================================================================
print_header "FASE 2: ELIMINACIÃ“N DEL CLÃšSTER KIND"
# ============================================================================

print_step "Verificando clÃºsteres Kind existentes..."
kind get clusters

if kind get clusters 2>/dev/null | grep -q "^${CLUSTER_NAME}$"; then
    print_warning "ClÃºster '$CLUSTER_NAME' encontrado. Eliminando..."
    kind delete cluster --name "$CLUSTER_NAME"
    print_success "ClÃºster eliminado"
    sleep 3
else
    print_info "ClÃºster '$CLUSTER_NAME' no existe, continuando..."
fi

# ============================================================================
print_header "FASE 3: CREACIÃ“N DEL NUEVO CLÃšSTER KIND"
# ============================================================================

print_step "Generando configuraciÃ³n de Kind con extraPortMappings..."

cat > "$WORK_DIR/kind-config.yaml" <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  # Apache
  - containerPort: 30080
    hostPort: 30080
    protocol: TCP
  # Portainer HTTP
  - containerPort: 30090
    hostPort: 30090
    protocol: TCP
  # Portainer HTTPS
  - containerPort: 30091
    hostPort: 30091
    protocol: TCP
  # Portainer Edge
  - containerPort: 30092
    hostPort: 30092
    protocol: TCP
- role: worker
- role: worker
EOF

print_success "ConfiguraciÃ³n generada en: $WORK_DIR/kind-config.yaml"

print_step "Creando clÃºster Kind con 3 nodos (1 control-plane + 2 workers)..."
print_info "Esto puede tardar 2-3 minutos..."

kind create cluster --name "$CLUSTER_NAME" --config "$WORK_DIR/kind-config.yaml" --wait 300s

print_success "ClÃºster creado exitosamente"

print_step "Esperando a que todos los nodos estÃ©n listos..."
kubectl wait --for=condition=Ready nodes --all --timeout=180s
print_success "Todos los nodos estÃ¡n listos"

print_step "Verificando nodos del clÃºster..."
kubectl get nodes -o wide

# Verificar que hay 3 nodos
NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
if [ "$NODE_COUNT" -eq 3 ]; then
    print_success "ClÃºster tiene 3 nodos como esperado"
else
    print_warning "ClÃºster tiene $NODE_COUNT nodos (se esperaban 3)"
fi

# ============================================================================
print_header "FASE 4: INSTALACIÃ“N DE PORTAINER"
# ============================================================================

print_step "Creando recursos de Portainer..."

cat > "$WORK_DIR/portainer-complete.yaml" <<'EOF'
---
apiVersion: v1
kind: Namespace
metadata:
  name: portainer

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: portainer-sa-clusteradmin
  namespace: portainer

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: portainer-crb-clusteradmin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: portainer-sa-clusteradmin
  namespace: portainer

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: portainer-data
  namespace: portainer
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: portainer
  namespace: portainer
  labels:
    app: portainer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: portainer
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: portainer
    spec:
      serviceAccountName: portainer-sa-clusteradmin
      containers:
      - name: portainer
        image: portainer/portainer-ce:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 9000
          protocol: TCP
          name: http
        - containerPort: 9443
          protocol: TCP
          name: https
        - containerPort: 8000
          protocol: TCP
          name: edge
        volumeMounts:
        - name: data
          mountPath: /data
        env:
        - name: PORTAINER_TUNNEL_PORT
          value: "8000"
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: portainer-data

---
apiVersion: v1
kind: Service
metadata:
  name: portainer
  namespace: portainer
  labels:
    app: portainer
spec:
  type: NodePort
  selector:
    app: portainer
  ports:
  - port: 9000
    targetPort: 9000
    nodePort: 30090
    protocol: TCP
    name: http
  - port: 9443
    targetPort: 9443
    nodePort: 30091
    protocol: TCP
    name: https
  - port: 8000
    targetPort: 8000
    nodePort: 30092
    protocol: TCP
    name: edge
EOF

print_success "Manifiestos de Portainer generados"

print_step "Aplicando recursos de Portainer..."
kubectl apply -f "$WORK_DIR/portainer-complete.yaml"

print_step "Esperando a que el namespace estÃ© activo..."
sleep 3

print_step "Esperando a que el PVC estÃ© bound..."
kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/portainer-data -n portainer --timeout=120s || print_warning "PVC aÃºn no estÃ¡ bound, continuando..."

print_step "Esperando a que Portainer estÃ© desplegado..."
kubectl wait --for=condition=Available deployment/portainer -n portainer --timeout=300s

print_success "Portainer desplegado exitosamente"

print_step "Verificando estado de Portainer..."
kubectl get pods -n portainer -o wide

# ============================================================================
print_header "FASE 5: VERIFICACIÃ“N DE CONECTIVIDAD"
# ============================================================================

print_step "Verificando port mappings en Docker..."
CONTROL_PLANE="${CLUSTER_NAME}-control-plane"
docker port "$CONTROL_PLANE" | grep -E "(30080|30090|30091|30092)"

print_step "Verificando endpoints de Portainer..."
kubectl get endpoints -n portainer

print_step "Esperando 10 segundos para que Portainer inicialice completamente..."
sleep 10

print_step "Probando conectividad interna..."
POD_IP=$(kubectl get pod -n portainer -o jsonpath='{.items[0].status.podIP}')
if [ -n "$POD_IP" ]; then
    TEST_RESULT=$(kubectl run test-final --image=curlimages/curl:latest --rm -i --restart=Never --command -- \
        curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "http://${POD_IP}:9000" 2>/dev/null || echo "000")
    
    if [ "$TEST_RESULT" = "307" ] || [ "$TEST_RESULT" = "200" ]; then
        print_success "Portainer responde internamente (HTTP $TEST_RESULT)"
    else
        print_warning "Portainer respondiÃ³ con HTTP $TEST_RESULT"
    fi
fi

# ============================================================================
print_header "RESUMEN DE LA INSTALACIÃ“N"
# ============================================================================

echo ""
print_success "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print_success "        ðŸŽ‰ INSTALACIÃ“N COMPLETADA EXITOSAMENTE ðŸŽ‰"
print_success "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo -e "${BOLD}ClÃºster Kind:${NC}"
echo "  â€¢ Nombre: $CLUSTER_NAME"
echo "  â€¢ Nodos: 3 (1 control-plane + 2 workers)"
echo ""

echo -e "${BOLD}Nodos activos:${NC}"
kubectl get nodes

echo ""
echo -e "${BOLD}Portainer instalado:${NC}"
echo "  â€¢ Namespace: portainer"
echo "  â€¢ Deployment: portainer"
echo "  â€¢ Replicas: 1"
echo ""

echo -e "${BOLD}Puertos mapeados:${NC}"
echo "  â€¢ 30080 â†’ Apache (HTTP)"
echo "  â€¢ 30090 â†’ Portainer (HTTP)"
echo "  â€¢ 30091 â†’ Portainer (HTTPS)"
echo "  â€¢ 30092 â†’ Portainer (Edge)"
echo ""

echo -e "${BOLD}${GREEN}Acceso a Portainer:${NC}"
echo ""
echo -e "${CYAN}  Desde tu mÃ¡quina local:${NC}"
echo "    â€¢ http://localhost:30090"
echo "    â€¢ https://localhost:30091"
echo ""

if [ "$HOST_IP" != "localhost" ]; then
    echo -e "${CYAN}  Desde la red local (IP detectada: ${BOLD}${HOST_IP}${NC}${CYAN}):${NC}"
    echo "    â€¢ http://${HOST_IP}:30090"
    echo "    â€¢ https://${HOST_IP}:30091"
    echo ""
else
    echo -e "${YELLOW}  (No se detectÃ³ IP en red 192.168.x.x)${NC}"
    echo ""
fi

echo -e "${BOLD}${YELLOW}IMPORTANTE - Primer acceso:${NC}"
echo "  1. Accede a Portainer en los prÃ³ximos 5 minutos"
echo "  2. Crea tu usuario administrador"
echo "  3. Selecciona el entorno 'Kubernetes local'"
echo ""

echo -e "${BOLD}Comandos Ãºtiles:${NC}"
echo "  â€¢ Ver pods de Portainer:"
echo "    kubectl get pods -n portainer -o wide"
echo ""
echo "  â€¢ Ver logs de Portainer:"
echo "    kubectl logs -n portainer -l app=portainer -f"
echo ""
echo "  â€¢ Ver todos los servicios:"
echo "    kubectl get svc --all-namespaces"
echo ""
echo "  â€¢ Ver distribuciÃ³n de pods en nodos:"
echo "    kubectl get pods -A -o wide"
echo ""

print_info "Archivos de configuraciÃ³n guardados en: $WORK_DIR"

echo ""
print_success "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Preguntar si desea hacer un test de conectividad
echo -e "${BOLD}Â¿Deseas probar la conectividad externa ahora? (s/n):${NC}"
read -p "> " test_conn

if [ "$test_conn" = "s" ] || [ "$test_conn" = "S" ]; then
    echo ""
    print_step "Probando conectividad externa a Portainer..."
    
    echo ""
    print_info "Intentando conectar a localhost:30090..."
    if curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 http://localhost:30090 | grep -q "307\|200"; then
        print_success "âœ“ Portainer es accesible en http://localhost:30090"
    else
        print_warning "âœ— No se pudo conectar a localhost:30090"
    fi
    
    if [ "$HOST_IP" != "localhost" ]; then
        echo ""
        print_info "Intentando conectar a ${HOST_IP}:30090..."
        if curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "http://${HOST_IP}:30090" | grep -q "307\|200"; then
            print_success "âœ“ Portainer es accesible en http://${HOST_IP}:30090"
        else
            print_warning "âœ— No se pudo conectar a ${HOST_IP}:30090"
            print_info "Esto puede ser normal si hay un firewall. Intenta desde el navegador."
        fi
    fi
fi

echo ""
print_success "Script completado. Â¡Disfruta tu nuevo clÃºster!"
echo ""

